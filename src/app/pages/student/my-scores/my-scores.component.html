<div class="container">
  <h2>üéì B·∫£ng k·∫øt qu·∫£ h·ªçc t·∫≠p</h2>

  <div *ngIf="isLoading" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
  <div *ngIf="errorMessage" class="error">{{ errorMessage }}</div>

  <div *ngIf="transcript" class="content">

    <div class="info-card" [ngClass]="{
      'graduated': transcript.status === 'ƒê√É T·ªêT NGHI·ªÜP',
      'expelled': transcript.status === 'BU·ªòC TH√îI H·ªåC'
    }">
      <h3>Sinh vi√™n: {{ transcript.studentName }}</h3>
      <p>Khoa: <strong>{{ transcript.facultyName }}</strong></p>
      <p>Tr·∫°ng th√°i: <strong>{{ transcript.status }}</strong></p>
      <p class="message">üîî {{ transcript.message }}</p>
      <p>L∆∞u √Ω: Click <i class="bi bi-flag-fill text-warning"></i> ƒë·ªÉ ph√∫c kh·∫£o ƒëi·ªÉm</p>
    </div>

    @if (transcript && transcript.scores && transcript.scores.length > 0) {
    <table class="score-table">
      <thead>
        <tr>
          <th class="center">STT</th>
          <th class="center">M√¥n h·ªçc</th>
          <th class="center">S·ªë TC</th>
          <th class="center">Qu√° tr√¨nh</th>
          <th class="center">ƒêi·ªÉm thi</th>
          <th class="center">T·ªïng k·∫øt</th>
          <th class="center">K·∫øt qu·∫£</th>
          <th class="center">Ng√†y c·∫≠p nh·∫≠t</th>
        </tr>
      </thead>
      <tbody>
        @for (s of transcript.scores; track s.subjectName; let i = $index) {
        <tr>
          <td class="center">{{ i + 1 }}</td>
          <td class="subject-name center">{{ s.subjectName }}</td>
          <td class="center">{{ s.credits }}</td>
          <td class="center">{{ s.processScore }}</td>
          <td class="center">{{ s.finalScore }}</td>
          <td class="center bold">
            {{ s.totalScore | number:'1.1-1' }}
            <button *ngIf="s.totalScore !== null" class="btn btn-sm btn-link text-warning p-0 ms-2"
              title="G·ª≠i ph√∫c kh·∫£o" (click)="openAppealModal(s)">
              <i class="bi bi-flag-fill"></i>
            </button>
          </td>

          <td class="center">
            @if (s.totalScore >= 4.0) { <span class="pass">ƒê·∫°t</span> }
            @else { <span class="fail">H·ªçc l·∫°i</span> }
          </td>
          <td class="center">{{s.updatedAt | date:'dd/MM/yyyy HH:mm'}}</td>
        </tr>
        }
      </tbody>
    </table>
    } @else {
    <div class="no-data">
      <div class="empty-state-icon">üìù</div>
      <p>Hi·ªán t·∫°i b·∫°n ch∆∞a c√≥ ƒëi·ªÉm m√¥n h·ªçc n√†o.</p>
    </div>
    }

    <div class="modal fade" id="appealModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title fw-bold">üö© Y√™u c·∫ßu ph√∫c kh·∫£o</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" *ngIf="selectedScoreForAppeal">
            <p><strong>M√¥n h·ªçc:</strong> {{ selectedScoreForAppeal.subjectName }}</p>
            <p><strong>ƒêi·ªÉm hi·ªán t·∫°i:</strong> {{ selectedScoreForAppeal.totalScore | number:'1.1-1'}}</p>

            <div class="mb-3">
              <label class="form-label">L√Ω do ph√∫c kh·∫£o <span class="text-danger">*</span></label>
              <textarea class="form-control" rows="4" [(ngModel)]="appealReason"
                placeholder="Vui l√≤ng tr√¨nh b√†y r√µ l√Ω do (VD: Em l√†m ƒë√∫ng c√¢u 3 nh∆∞ng ch∆∞a ƒë∆∞·ª£c t√≠nh ƒëi·ªÉm...)"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            <button type="button" class="btn btn-warning fw-bold" (click)="submitAppeal()"
              [disabled]="!appealReason || appealReason.trim().length < 10">
              G·ª≠i ƒë∆°n
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>