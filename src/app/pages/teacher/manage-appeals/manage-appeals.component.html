<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-primary">üì© Qu·∫£n L√Ω Ph√∫c Kh·∫£o</h2>
    <button class="btn btn-outline-primary" (click)="loadPendingAppeals()">
      <i class="bi bi-arrow-clockwise"></i> L√†m m·ªõi
    </button>
  </div>

  <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="bg-light">
          <tr>
            <th class="ps-4 text-center">SV</th>
            <th class="text-center">M√¥n h·ªçc</th>
            <th class="text-center">ƒêi·ªÉm c≈©</th>
            <th class="text-center" style="width: 30%;">L√Ω do</th>
            <th class="text-center">Tr·∫°ng th√°i</th>
            <th class="text-end pe-4">H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody>
          @for (appeal of appeals; track appeal.id) {
          <tr>
            <td class="ps-4 text-center">
              <div class="fw-bold">{{ appeal.studentName }}</div>
              <small class="text-muted">{{ appeal.studentCode }}</small>
            </td>
            <td class="fw-bold text-primary text-center">{{ appeal.subjectName }}</td>
            <td class="fw-bold text-center">{{ appeal.oldScore }}</td>
            <td class="text-center">
              <div class="text-truncate" style="max-width: 250px;" [title]="appeal.reason">
                {{ appeal.reason }}
              </div>
            </td>
            <td class="text-center"><span class="badge bg-warning text-dark">Ch·ªù duy·ªát</span></td>
            <td class="text-end pe-4">
              <button class="btn btn-sm btn-primary px-3 rounded-pill" data-bs-toggle="modal"
                data-bs-target="#reviewModal" (click)="openReviewModal(appeal)">
                X·ª≠ l√Ω
              </button>
            </td>
          </tr>
          } @empty {
          <tr>
            <td colspan="6" class="text-center py-5 text-muted">
              üéâ Kh√¥ng c√≥ ƒë∆°n ph√∫c kh·∫£o n√†o c·∫ßn x·ª≠ l√Ω.
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">X·ª≠ l√Ω ƒë∆°n ph√∫c kh·∫£o #{{ selectedAppeal?.id }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body p-4" *ngIf="selectedAppeal">
        <div class="alert alert-light border mb-3">
          <p class="mb-1"><strong>Sinh vi√™n:</strong> {{ selectedAppeal.studentName }} ({{ selectedAppeal.studentCode
            }})</p>
          <p class="mb-1"><strong>M√¥n:</strong> {{ selectedAppeal.subjectName }}</p>
          <p class="mb-0"><strong>L√Ω do SV:</strong> "{{ selectedAppeal.reason }}"</p>
        </div>

        <form [formGroup]="reviewForm" (ngSubmit)="submitReview()">

          <div class="mb-3">
            <label class="form-label">Quy·∫øt ƒë·ªãnh</label>
            <select class="form-select" formControlName="status">
              <option value="APPROVED">Ch·∫•p nh·∫≠n (S·ª≠a ƒëi·ªÉm)</option>
              <option value="REJECTED">T·ª´ ch·ªëi (Gi·ªØ nguy√™n)</option>
            </select>
          </div>

          <div class="mb-3" *ngIf="reviewForm.get('status')?.value === 'APPROVED'">
            <label class="form-label">ƒêi·ªÉm s·ªë m·ªõi <span class="text-danger">*</span></label>
            <input type="number" class="form-control" formControlName="newScore"
              [class.is-invalid]="reviewForm.get('newScore')?.invalid && reviewForm.get('newScore')?.touched">

            <div class="invalid-feedback">
              <span *ngIf="reviewForm.get('newScore')?.hasError('required')">Vui l√≤ng nh·∫≠p ƒëi·ªÉm m·ªõi.</span>
              <span
                *ngIf="reviewForm.get('newScore')?.hasError('min') || reviewForm.get('newScore')?.hasError('max')">ƒêi·ªÉm
                ph·∫£i t·ª´ 0 ƒë·∫øn 10.</span>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Ph·∫£n h·ªìi cho sinh vi√™n <span class="text-danger">*</span></label>
            <textarea class="form-control" rows="3" formControlName="teacherResponse"
              [class.is-invalid]="reviewForm.get('teacherResponse')?.invalid && reviewForm.get('teacherResponse')?.touched"></textarea>

            <div class="invalid-feedback">
              Vui l√≤ng nh·∫≠p l√Ω do/ph·∫£n h·ªìi (√≠t nh·∫•t 10 k√Ω t·ª±).
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            <button type="submit" class="btn btn-primary" [disabled]="isProcessing">
              <span *ngIf="isProcessing" class="spinner-border spinner-border-sm me-1"></span>
              X√°c nh·∫≠n
            </button>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        <button type="button" class="btn btn-primary" (click)="submitReview()"
          [disabled]="reviewForm.invalid || isProcessing">
          @if(isProcessing) { <span class="spinner-border spinner-border-sm"></span> }
          @else { X√°c nh·∫≠n }
        </button>
      </div>
    </div>
  </div>
</div>